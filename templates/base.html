{% load static %}
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>{% block title %}Дача | Доставка еды{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Inter"', 'sans-serif'],
            },
            colors: {
              brand: {
                black: '#21201F',
                yellow: '#FCE000',
                gray: '#F5F4F2',
                green: '#2F5D48',
              }
            },
            boxShadow: {
              'card': '0 4px 24px rgba(0, 0, 0, 0.06)',
              'float': '0 8px 30px rgba(0, 0, 0, 0.12)',
              'glow': '0 0 40px rgba(252, 224, 0, 0.3)',
            }
          }
        }
      }
    </script>
    <style>
      html { scroll-behavior: smooth; }
      body { background-color: #FFFFFF; color: #21201F; -webkit-font-smoothing: antialiased; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body class="font-sans antialiased pb-20 md:pb-0 flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-b border-gray-100 h-[72px] flex items-center transition-all">
      <div class="max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
        
        <!-- Logo -->
        <a href="/" class="flex items-center hover:opacity-80 transition-opacity">
           <span class="font-extrabold text-2xl tracking-tight text-brand-black">
             Дача <span class="font-medium text-brand-black">для Друзей</span>
           </span>
        </a>

        <!-- Actions -->
        <div class="flex items-center gap-3">
             <!-- Auth Check -->
             {% if user.is_authenticated %}
                <a href="{% url 'profile' %}" class="hidden md:flex items-center gap-2 text-sm font-bold text-brand-black hover:text-brand-green bg-brand-gray px-4 py-2.5 rounded-2xl transition-colors">
                    <i data-lucide="user" width="18"></i>
                    Профиль
                </a>
             {% else %}
                <button onclick="openModal('auth-modal')" class="hidden md:flex items-center gap-2 text-sm font-bold text-brand-black hover:text-brand-green px-4 py-2 transition-colors">
                    Войти
                </button>
             {% endif %}
             
             <!-- Cart Button -->
             <button onclick="openModal('cart-modal')" class="relative bg-brand-yellow hover:brightness-105 text-brand-black px-4 py-2.5 rounded-2xl font-bold text-sm transition-all flex items-center gap-2">
                <span class="hidden sm:inline">Корзина</span>
                <i data-lucide="shopping-bag" width="20"></i>
                <span id="cart-badge" class="hidden bg-white text-brand-black text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[20px]">0</span>
             </button>
        </div>
      </div>
    </nav>

    <div class="h-[72px]"></div>

    <main class="flex-grow">
        {% block content %}
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-brand-black text-white pt-16 pb-8 border-t border-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12 mb-16">
              
              <!-- Brand & Social -->
              <div class="space-y-6">
                  <div>
                      <h3 class="font-extrabold text-2xl tracking-tight text-white mb-2">
                         Дача <span class="font-medium text-gray-400">для Друзей</span>
                      </h3>
                      <p class="text-gray-500 text-sm leading-relaxed">
                          Уютное место в Снежинске, где вкусная еда встречается с теплой атмосферой.
                      </p>
                  </div>
                  
                  <!-- Socials -->
                  <div class="flex gap-4">
                      <!-- VK Icon (FIXED with Clean Path) -->
                      <a href="#" class="w-10 h-10 bg-white/10 hover:bg-[#0077FF] rounded-xl flex items-center justify-center transition-colors text-white group">
                          <svg role="img" viewBox="0 0 24 24" class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20.9,7.4c0.2-0.7,0-1.5-1.2-1.5h-4c-1.1,0-1.6,0.6-1.9,1.2c0,0-2.2,5.2-5.3,8.6 c-1,1-1.5,1.3-2,1.3c-0.3,0-0.7-0.3-0.7-1.2v-5.6c0-0.7-0.2-1.1-0.6-1.4c-0.4-0.3-1-0.4-1.5-0.4c-0.3,0-0.6,0.1-0.9,0.3 c-0.6,0.5,0.4,1,1.4,1.3c0.6,0.2,0.8,0.7,0.8,2v4.4c0,0.9-0.2,1.6-1.6,1.6c-2.3,0-7.8-8.2-7.8-8.2C-0.7,9,0.5,7.4,0.5,7.4H4 c1.2,0,1.3,0.6,1.3,0.6s2.3,5.5,5.4,8.3c1,0.9,1.7,0.7,1.7,0.7v-4.8c0-1.5-0.4-2.2-1.2-2.3c0.4-1.5,2-2.5,4.3-2.3 c1.5,0.1,2.5,0.9,2.8,2.5c0,0,0.8,3.9,1.9,5.7c1,1.7,1.8,1.3,1.8,1.3l3.6-0.1c1.1,0,1.5-0.6,1.2-1.3C25.8,13.6,22.2,9.6,20.9,7.4z"/>
                          </svg>
                      </a>
                  </div>
              </div>

              <!-- Menu Links (Help) -->
              <div>
                  <h4 class="font-bold text-lg mb-6">Помощь</h4>
                  <ul class="space-y-3 text-sm text-gray-400">
                      <li><a href="policy.html" class="hover:text-brand-yellow transition-colors">Политика обработки персональных данных</a></li>
                      <li><a href="offer.html" class="hover:text-brand-yellow transition-colors">Публичная оферта</a></li>
                      <li><a href="requisites.html" class="hover:text-brand-yellow transition-colors">Реквизиты</a></li>
                      <li><a href="vacancies.html" class="hover:text-brand-yellow transition-colors">Вакансии</a></li>
                  </ul>
              </div>

              <!-- Contacts -->
              <div>
                  <h4 class="font-bold text-lg mb-6">Контакты</h4>
                  <ul class="space-y-4 text-sm text-gray-400">
                      <li class="flex items-start gap-3">
                          <i data-lucide="map-pin" class="w-5 h-5 text-brand-green shrink-0 mt-0.5"></i>
                          <span>Снежинск, ул. Комсомольская 3А<br>(Парк Культуры)</span>
                      </li>
                      <li class="flex items-center gap-3">
                          <i data-lucide="phone" class="w-5 h-5 text-brand-green shrink-0"></i>
                          <a href="tel:+73514692211" class="hover:text-white transition-colors">+7 (351) 469-22-11</a>
                      </li>
                  </ul>
                  
                  <!-- Payment Methods Badge -->
                  <div class="mt-8 pt-6 border-t border-gray-800">
                      <p class="text-xs text-gray-500 mb-3 uppercase font-bold tracking-wider">Мы принимаем</p>
                      <div class="flex items-center gap-3 grayscale opacity-70 hover:grayscale-0 hover:opacity-100 transition-all duration-300">
                          <!-- Visa -->
                          <div class="h-6 bg-white rounded px-2 flex items-center"><img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" class="h-3 w-auto" alt="Visa"></div>
                          <!-- Mastercard -->
                          <div class="h-6 bg-white rounded px-2 flex items-center"><img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" class="h-4 w-auto" alt="Mastercard"></div>
                          <!-- Mir -->
                          <div class="h-6 bg-white rounded px-2 flex items-center"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b9/Mir-logo.SVG.svg" class="h-3 w-auto" alt="Mir"></div>
                      </div>
                  </div>
              </div>

          </div>

          <div class="border-t border-gray-800 pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-gray-600">
              <p>© {% now "Y" %} Дача. Все права защищены.</p>
              <p>Разработано для людей</p>
          </div>
      </div>
    </footer>

    <!-- ================= MODALS ================= -->

    <!-- Auth Modal (Login/Register) -->
    <div id="auth-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('auth-modal')"></div>
        <div class="relative bg-white rounded-3xl shadow-float w-full max-w-sm overflow-hidden fade-in p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Вход на сайт</h2>
                <button onclick="closeModal('auth-modal')" class="bg-gray-100 p-2 rounded-full"><i data-lucide="x" width="20"></i></button>
            </div>
            
            <!-- Tabs -->
            <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
                <button onclick="switchAuthTab('login')" id="tab-login" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm transition-all">Вход</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="flex-1 py-2 text-sm font-bold text-gray-500 rounded-lg hover:bg-white/50 transition-all">Регистрация</button>
            </div>

            <!-- Login Form -->
            <form id="form-login" class="space-y-4" method="POST" action="{% url 'login' %}">
                {% csrf_token %}
                <input type="text" name="username" placeholder="Телефон" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                <input type="password" name="password" placeholder="Пароль" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                <button type="submit" class="w-full bg-brand-green text-white py-3 rounded-xl font-bold hover:brightness-110">Войти</button>
            </form>

            <!-- Register Form (Hidden) -->
            <form id="form-register" class="space-y-4 hidden" method="POST" action="{% url 'register' %}">
                {% csrf_token %}
                <input type="text" name="phone" placeholder="Телефон" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                <input type="text" name="first_name" placeholder="Имя" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                <input type="password" name="password" placeholder="Пароль" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                <button type="submit" class="w-full bg-brand-yellow text-brand-black py-3 rounded-xl font-bold hover:brightness-105">Создать аккаунт</button>
            </form>
        </div>
    </div>

    <!-- Checkout / Cart Modal (Advanced) -->
    <div id="cart-modal" class="hidden fixed inset-0 z-[60] overflow-hidden">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px] transition-opacity" onclick="closeModal('cart-modal')"></div>
        <div class="absolute inset-y-0 right-0 max-w-full flex">
            <div class="w-screen max-w-[480px] bg-white shadow-2xl flex flex-col h-full fade-in">
                
                <!-- Header -->
                <div class="p-6 flex items-center justify-between border-b border-gray-100 bg-white z-10">
                    <h2 class="text-2xl font-bold">Оформление</h2>
                    <button onclick="closeModal('cart-modal')" class="bg-brand-gray p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" width="20"></i></button>
                </div>

                <!-- Scrollable Content -->
                <form id="checkout-form" class="flex-1 overflow-y-auto p-6 space-y-8" method="POST" action="{% url 'create_order' %}">
                    {% csrf_token %}
                    <!-- Hidden input for cart JSON -->
                    <input type="hidden" name="cart_data" id="cart-data-input">

                    <!-- Cart Items Preview -->
                    <div id="cart-items" class="space-y-4">
                        <div class="text-center text-gray-400 py-10">Корзина пуста</div>
                    </div>

                    <!-- 0. Contact Info -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-lg">Контактные данные</h3>
                        <input type="text" name="receiver_name" placeholder="Имя получателя" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                        <input type="tel" name="phone" id="order-phone" placeholder="+7 (999) 000-00-00" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                    </div>

                    <!-- 1. Delivery Method -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-lg">Способ получения</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="delivery_method" value="delivery" checked class="peer sr-only" onchange="toggleDeliveryFields(this.value)">
                                <div class="p-3 rounded-xl border-2 border-transparent bg-brand-gray peer-checked:bg-white peer-checked:border-brand-yellow transition-all text-center">
                                    <span class="block font-bold">Доставка</span>
                                    <span class="text-xs text-gray-500">~40 мин</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="delivery_method" value="pickup" class="peer sr-only" onchange="toggleDeliveryFields(this.value)">
                                <div class="p-3 rounded-xl border-2 border-transparent bg-brand-gray peer-checked:bg-white peer-checked:border-brand-yellow transition-all text-center">
                                    <span class="block font-bold">Самовывоз</span>
                                    <span class="text-xs text-gray-500">Парк Культуры</span>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Address Fields (Shown if Delivery) -->
                        <div id="delivery-address-block" class="space-y-3 pt-2 animate-in slide-in-from-top-2 duration-200">
                             <input type="text" name="address" placeholder="Улица, дом" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                             <div class="grid grid-cols-2 gap-3">
                                 <input type="text" name="entrance" placeholder="Подъезд" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                                 <input type="text" name="floor" placeholder="Этаж" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow">
                             </div>
                        </div>

                        <!-- Pickup Info (Shown if Pickup) -->
                        <div id="pickup-info-block" class="hidden bg-green-50 text-brand-green p-4 rounded-xl border border-green-100 flex items-start gap-3">
                            <i data-lucide="map-pin" class="w-5 h-5 mt-0.5 shrink-0"></i>
                            <div>
                                <p class="font-bold text-sm">Адрес самовывоза:</p>
                                <p class="text-sm">г. Снежинск, ул. Комсомольская 3А (Парк Культуры)</p>
                            </div>
                        </div>

                        <textarea name="comment" placeholder="Комментарий к заказу" rows="2" class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-brand-yellow"></textarea>
                    </div>

                    <!-- 2. Payment Method -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-lg">Оплата</h3>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center gap-3 p-3 rounded-xl bg-brand-gray cursor-pointer hover:bg-gray-200 transition-colors">
                                <input type="radio" name="payment_method" value="card" checked class="w-5 h-5 text-brand-green focus:ring-brand-green">
                                <i data-lucide="credit-card" class="w-5 h-5 text-gray-600"></i>
                                <span class="font-medium">Картой курьеру / онлайн</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 rounded-xl bg-brand-gray cursor-pointer hover:bg-gray-200 transition-colors">
                                <input type="radio" name="payment_method" value="cash" class="w-5 h-5 text-brand-green focus:ring-brand-green">
                                <i data-lucide="banknote" class="w-5 h-5 text-gray-600"></i>
                                <span class="font-medium">Наличными</span>
                            </label>
                        </div>
                    </div>

                    <!-- 3. Promo Code -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-lg">Промокод</h3>
                        <div class="flex gap-2">
                            <input type="text" id="promo-input" name="promo_code" placeholder="Введите код (например ДАЧА10)" class="flex-1 bg-brand-gray px-4 py-3 rounded-xl font-medium outline-none uppercase tracking-wide">
                            <button type="button" onclick="applyPromo()" class="bg-brand-black text-white px-4 rounded-xl font-bold hover:opacity-80 transition-opacity">
                                <i data-lucide="check" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p id="promo-message" class="text-sm font-medium hidden"></p>
                    </div>

                </form>

                <!-- Sticky Footer -->
                <div class="p-6 border-t border-gray-100 bg-white">
                    <div class="flex justify-between items-end mb-4">
                         <span class="text-gray-500 font-medium">Итого к оплате:</span>
                         <div class="text-right">
                             <span id="old-price" class="text-sm text-gray-400 line-through hidden font-bold">0 ₽</span>
                             <span id="total-price" class="text-2xl font-extrabold text-brand-black">0 ₽</span>
                         </div>
                    </div>
                    <button type="submit" form="checkout-form" class="w-full bg-brand-yellow hover:brightness-105 text-brand-black py-4 rounded-2xl font-bold text-lg shadow-float transition-all transform active:scale-[0.98]">
                        Оформить заказ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Modal (Existing) -->
    <div id="reservation-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('reservation-modal')"></div>
        <div class="relative bg-white rounded-3xl shadow-float w-full max-w-md overflow-hidden fade-in">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-xl font-bold">Бронирование стола</h2>
                <button onclick="closeModal('reservation-modal')" class="bg-gray-100 p-2 rounded-full"><i data-lucide="x" width="20"></i></button>
            </div>
            <form class="p-6 space-y-4" method="POST" action="{% url 'reservation' %}">
                {% csrf_token %}
                <input type="text" name="name" required class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium" placeholder="Имя">
                <input type="tel" name="phone" required class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium" placeholder="Телефон">
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" name="date" required class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium">
                    <input type="time" name="time" required class="w-full bg-brand-gray px-4 py-3 rounded-xl font-medium">
                </div>
                <button type="submit" class="w-full bg-brand-green text-white py-4 rounded-xl font-bold mt-2">Забронировать</button>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        lucide.createIcons();
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.body.style.overflow = ''; }

        // Better Phone Mask Logic
        const phoneInput = document.getElementById('order-phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                // Prevent interference with backspace/delete
                if (e.inputType === 'deleteContentBackward') return;
                
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
                if (!x) return;

                // Force 7 as first digit if data exists
                if (x[1] === '8' || x[1] === '7') x[1] = '7';
                
                // Construct mask
                let val = !x[2] ? '+7' : '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
                e.target.value = val;
            });
            
            phoneInput.addEventListener('focus', function(e) {
                if(!e.target.value) e.target.value = '+7 (';
            });
        }

        // Auth Tabs Logic
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('form-login');
            const regForm = document.getElementById('form-register');
            const loginBtn = document.getElementById('tab-login');
            const regBtn = document.getElementById('tab-register');

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
                loginBtn.classList.add('bg-white', 'shadow-sm', 'text-black');
                loginBtn.classList.remove('text-gray-500');
                regBtn.classList.remove('bg-white', 'shadow-sm', 'text-black');
                regBtn.classList.add('text-gray-500');
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                regBtn.classList.add('bg-white', 'shadow-sm', 'text-black');
                regBtn.classList.remove('text-gray-500');
                loginBtn.classList.remove('bg-white', 'shadow-sm', 'text-black');
                loginBtn.classList.add('text-gray-500');
            }
        }

        // Full Cart Logic
        let cart = [];
        let currentDiscount = 0;

        function addToCart(title, price) {
            // Ensure price is numeric
            const numericPrice = typeof price === 'string' ? parseFloat(price) : price;
            
            const existing = cart.find(i => i.title === title);
            if(existing) {
                existing.qty++;
            } else {
                cart.push({ title, price: numericPrice, qty: 1 });
            }
            updateCartUI();
            // REMOVED: openModal('cart-modal');
        }

        function updateCartUI() {
            // Update Badge
            const count = cart.reduce((acc, i) => acc + i.qty, 0);
            const badge = document.getElementById('cart-badge');
            if (badge) {
                badge.innerText = count;
                badge.classList.toggle('hidden', count === 0);
            }

            // Update List
            const container = document.getElementById('cart-items');
            if (container) {
                if (count === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10">Корзина пуста</div>';
                } else {
                    container.innerHTML = cart.map((item, index) => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-50">
                            <div>
                                <div class="font-medium">${item.title}</div>
                                <div class="text-xs text-gray-400">${item.price} ₽ x ${item.qty}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold">${item.price * item.qty} ₽</span>
                                <div class="flex items-center gap-1 bg-gray-100 rounded-lg">
                                   <button onclick="updateQty(${index}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-red-500">-</button>
                                   <button onclick="updateQty(${index}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-green-500">+</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Update Total
            calculateTotal();

            // Sync hidden input
            const hiddenInput = document.getElementById('cart-data-input');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(cart);
            }
        }

        function updateQty(index, delta) {
            if (cart[index]) {
                cart[index].qty += delta;
                if (cart[index].qty <= 0) {
                    cart.splice(index, 1);
                }
                updateCartUI();
            }
        }

        function calculateTotal() {
            const rawTotal = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            const finalTotal = Math.round(rawTotal * (1 - currentDiscount));
            
            const totalEl = document.getElementById('total-price');
            const oldEl = document.getElementById('old-price');
            
            if (totalEl) totalEl.innerText = finalTotal + ' ₽';
            
            if (oldEl) {
                if (currentDiscount > 0 && rawTotal > 0) {
                    oldEl.innerText = rawTotal + ' ₽';
                    oldEl.classList.remove('hidden');
                    totalEl.classList.add('text-green-600');
                } else {
                    oldEl.classList.add('hidden');
                    totalEl.classList.remove('text-green-600');
                }
            }
        }

        // Delivery Toggle Logic
        function toggleDeliveryFields(method) {
            const addressBlock = document.getElementById('delivery-address-block');
            const pickupBlock = document.getElementById('pickup-info-block');
            
            if (method === 'pickup') {
                addressBlock.classList.add('hidden');
                pickupBlock.classList.remove('hidden');
            } else {
                addressBlock.classList.remove('hidden');
                pickupBlock.classList.add('hidden');
            }
        }

        // Promo Logic
        function applyPromo() {
            const code = document.getElementById('promo-input').value.trim().toUpperCase();
            const msg = document.getElementById('promo-message');
            
            if (code === 'ДАЧА10' || code === 'DACHA10') {
                currentDiscount = 0.10;
                if(msg) {
                    msg.innerText = 'Скидка 10% применена!';
                    msg.className = 'text-sm font-bold text-brand-green mt-1';
                    msg.classList.remove('hidden');
                }
                calculateTotal();
            } else if (code === '') {
                currentDiscount = 0;
                if(msg) msg.classList.add('hidden');
                calculateTotal();
            } else {
                currentDiscount = 0;
                if(msg) {
                    msg.innerText = 'Промокод не найден';
                    msg.className = 'text-sm font-bold text-red-500 mt-1';
                    msg.classList.remove('hidden');
                }
                calculateTotal();
            }
        }
    </script>
  </body>
</html>
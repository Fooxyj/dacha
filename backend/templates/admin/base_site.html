{% extends "admin/base.html" %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">{{ site_header|default:_('Django administration') }}</a></h1>
{% endblock %}

{% block nav-global %}
<style>
    /* Force visible checkboxes in Admin with custom styling */
    input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        background-color: white !important;
        border: 1px solid #aaa !important;
        width: 18px;
        height: 18px;
        cursor: pointer;
        border-radius: 3px;
        position: relative;
        display: inline-block;
        vertical-align: middle;
        outline: none;
    }

    /* Checked state: Blue background, White tick */
    input[type="checkbox"]:checked {
        background-color: #007bff !important;
        border-color: #007bff !important;
    }

    input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 2px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    /* Ensure specific admin tables don't override this */
    td.action-checkbox input,
    th.action-checkbox-column input,
    .action-checkbox input {
        filter: none !important;
    }
</style>
{% endblock %}

{% block footer %}
{{ block.super }}
<audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
    preload="auto"></audio>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const audio = document.getElementById('notification-sound');

        function checkNewOrders() {
            fetch('/api/admin/check-new/')
                .then(response => response.json())
                .then(data => {
                    if (data.play_sound) {
                        // Play sound
                        audio.play().catch(e => console.log('Audio play failed (interaction needed?):', e));

                        // Show browser notification if allowed
                        if (Notification.permission === "granted") {
                            new Notification("Новый заказ или бронь!", {
                                body: `Заказов: ${data.recent_orders}, Броней: ${data.recent_reservations}`
                            });
                        } else if (Notification.permission !== "denied") {
                            Notification.requestPermission();
                        }
                    }
                })
                .catch(err => console.error('Check orders failed', err));
        }

        // Check every 30 seconds
        setInterval(checkNewOrders, 30000);

        // Request notification permission on load
        if (Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission();
        }
    });
</script>
{% endblock %}